// @generated by next-prisma-flow-state-engine
// file: queries.server.ts

"use server";

import { prisma } from "../../../lib/prisma";
import { cacheTagged, keys, FlowCtx } from "../core";
import { canTag } from "../policies";
import { TagDeepSelect, TagListSelect } from "./selects";
import type { Prisma } from "@prisma/client";

export const getTagById = cacheTagged(async function (
  id: string,
  ctx: FlowCtx,
) {
  const policy = await canTag("read", ctx);
  if (!policy.ok) return null;

  const item = await prisma.tag.findUnique({
    where: { id: id, ...policy.where },
    select: TagDeepSelect,
  });

  return item;
});

export type TagListParams = {
  where?: Prisma.TagWhereInput;
  orderBy?: Prisma.TagOrderByWithRelationInput;
  skip?: number;
  take?: number;
};

export const listTags = cacheTagged(async function (
  params: TagListParams,
  ctx: FlowCtx,
) {
  const policy = await canTag("list", ctx);
  if (!policy.ok) return { items: [], total: 0 };

  const where = { ...params.where, ...policy.where };

  const [items, total] = await Promise.all([
    prisma.tag.findMany({
      where,
      orderBy: params.orderBy,
      skip: params.skip,
      take: params.take || 50,
      select: TagListSelect,
    }),
    prisma.tag.count({ where }),
  ]);

  return { items, total };
});
