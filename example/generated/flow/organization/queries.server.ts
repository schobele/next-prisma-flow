// @generated by next-prisma-flow-state-engine
// file: queries.server.ts

"use server";

import { prisma } from "../../../lib/prisma";
import { cacheTagged, keys, FlowCtx } from "../core";
import { canOrganization } from "../policies";
import { OrganizationDeepSelect, OrganizationListSelect } from "./selects";
import type { Prisma } from "@prisma/client";

export const getOrganizationById = cacheTagged(async function (
  id: string,
  ctx: FlowCtx,
) {
  const policy = await canOrganization("read", ctx);
  if (!policy.ok) return null;

  const item = await prisma.organization.findUnique({
    where: { id: id, ...policy.where },
    select: OrganizationDeepSelect,
  });

  return item;
});

export type OrganizationListParams = {
  where?: Prisma.OrganizationWhereInput;
  orderBy?: Prisma.OrganizationOrderByWithRelationInput;
  skip?: number;
  take?: number;
};

export const listOrganizations = cacheTagged(async function (
  params: OrganizationListParams,
  ctx: FlowCtx,
) {
  const policy = await canOrganization("list", ctx);
  if (!policy.ok) return { items: [], total: 0 };

  const where = { ...params.where, ...policy.where };

  const [items, total] = await Promise.all([
    prisma.organization.findMany({
      where,
      orderBy: params.orderBy,
      skip: params.skip,
      take: params.take || 50,
      select: OrganizationListSelect,
    }),
    prisma.organization.count({ where }),
  ]);

  return { items, total };
});
