// @generated by next-prisma-flow-state-engine
// file: queries.server.ts

"use server";

import { prisma } from "../../../lib/prisma";
import { cacheTagged, keys, FlowCtx } from "../core";
import { canAuthor } from "../policies";
import { AuthorDeepSelect, AuthorListSelect } from "./selects";
import type { Prisma } from "@prisma/client";

export const getAuthorById = cacheTagged(async function (
  id: string,
  ctx: FlowCtx,
) {
  const policy = await canAuthor("read", ctx);
  if (!policy.ok) return null;

  const item = await prisma.author.findUnique({
    where: { id: id, ...policy.where },
    select: AuthorDeepSelect,
  });

  return item;
});

export type AuthorListParams = {
  where?: Prisma.AuthorWhereInput;
  orderBy?: Prisma.AuthorOrderByWithRelationInput;
  skip?: number;
  take?: number;
};

export const listAuthors = cacheTagged(async function (
  params: AuthorListParams,
  ctx: FlowCtx,
) {
  const policy = await canAuthor("list", ctx);
  if (!policy.ok) return { items: [], total: 0 };

  const where = { ...params.where, ...policy.where };

  const [items, total] = await Promise.all([
    prisma.author.findMany({
      where,
      orderBy: params.orderBy,
      skip: params.skip,
      take: params.take || 50,
      select: AuthorListSelect,
    }),
    prisma.author.count({ where }),
  ]);

  return { items, total };
});
