// @generated by next-prisma-flow-state-engine
// file: queries.server.ts

"use server";

import { prisma } from "../../../lib/prisma";
import { cacheTagged, keys, FlowCtx } from "../core";
import { canPost } from "../policies";
import { PostDeepSelect, PostListSelect } from "./selects";
import type { Prisma } from "@prisma/client";

export const getPostById = cacheTagged(async function (
  id: string,
  ctx: FlowCtx,
) {
  const policy = await canPost("read", ctx);
  if (!policy.ok) return null;

  const item = await prisma.post.findUnique({
    where: { id: id, ...policy.where },
    select: PostDeepSelect,
  });

  return item;
});

export type PostListParams = {
  where?: Prisma.PostWhereInput;
  orderBy?: Prisma.PostOrderByWithRelationInput;
  skip?: number;
  take?: number;
};

export const listPosts = cacheTagged(async function (
  params: PostListParams,
  ctx: FlowCtx,
) {
  const policy = await canPost("list", ctx);
  if (!policy.ok) return { items: [], total: 0 };

  const where = { ...params.where, ...policy.where };

  const [items, total] = await Promise.all([
    prisma.post.findMany({
      where,
      orderBy: params.orderBy,
      skip: params.skip,
      take: params.take || 50,
      select: PostListSelect,
    }),
    prisma.post.count({ where }),
  ]);

  return { items, total };
});
